<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="./WhatsApp Image 2025-09-15 at 23.23.46.webp">
  <title>Admin - User Login Activity</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="site-header small">
    <div class="container header-inner">
      <div class="brand">
        <img src="./WhatsApp Image 2025-09-15 at 23.23.46.webp" alt="Logo" class="logo">
        <div>
          <h1>Alumni Portal</h1>
          <p class="tagline">Admin Dashboard</p>
        </div>
      </div>
      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="users.html">Users</a>
        <a href="welcome.html">Dashboard</a>
        <a href="#" onclick="logout()" class="btn ghost small">Logout</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="users-box fade-up">
      <h2>User Login Activity</h2>
      <p class="muted">Below are login activities. Only visible to admin.</p>
      <table id="activityTable" class="users-table">
        <thead><tr><th>#</th><th>Email</th><th>Login Time</th></tr></thead>
        <tbody></tbody>
      </table>
      <p id="noActivity" class="muted" style="display:none">No login activity found.</p>
      <p id="adminError" class="muted" style="color:red;"></p>
    </section>
  </main>

  <!-- load config.js BEFORE any script that uses API_BASE -->
  <script src="config.js"></script>

  <script>
    // Use config.js window.API_BASE or fallback to localhost for dev
    const API_BASE = window.API_BASE || 'http://localhost:3001';

    const current = JSON.parse(localStorage.getItem('currentUser') || 'null');
    const token = localStorage.getItem('token');

    // Verify admin role from user object
    if (!current || current.role !== 'admin' || !token) {
      window.location.href = 'admin-login.html';
    }

    async function renderActivity() {
      try {
        const resp = await fetch(`${API_BASE}/api/activity`, {
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
        });

        if (!resp.ok) {
          const err = await resp.json().catch(()=>({ error: 'Unknown server error' }));
          document.getElementById('adminError').textContent = err.error || 'Server error';
          document.getElementById('activityTable').style.display = 'none';
          return;
        }

        const data = await resp.json();
        const tbody = document.querySelector('#activityTable tbody');
        tbody.innerHTML = '';

        if (!Array.isArray(data) || data.length === 0) {
          document.getElementById('noActivity').style.display = 'block';
          document.getElementById('activityTable').style.display = 'none';
          return;
        }

        document.getElementById('noActivity').style.display = 'none';
        document.getElementById('activityTable').style.display = 'table';

        data.forEach((a, i) => {
          // server returns: { id, user_id, email, when_ts }
          const email = a.email || ('user:' + (a.user_id || 'N/A'));
          const when = a.when_ts || a.when || a.time;
          const timeText = when ? new Date(when).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) : '-';

          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(email)}</td><td>${escapeHtml(timeText)}</td>`;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error('Activity fetch error:', err);
        document.getElementById('adminError').textContent = 'Network or server error.';
      }
    }

    // small escaping helper to avoid HTML injection from unexpected values
    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"'`=\/]/g, function(s) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',"/":'&#x2F;','`':'&#96;','=':'&#61;'})[s];
      });
    }

    function logout() {
      localStorage.removeItem('currentUser');
      localStorage.removeItem('token');
      window.location.href = 'index.html';
    }

    renderActivity();
  </script>
  <script src="config.js"></script>
  <script src="script.js"></script>
</body>
</html>



