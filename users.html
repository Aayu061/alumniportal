<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/webp" href="./WhatsApp Image 2025-09-15 at 23.23.46.webp">
  <title>Users - Alumni Portal (Admin)</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="site-header small">
    <div class="container header-inner">
      <div class="brand">
        <img src="./WhatsApp Image 2025-09-15 at 23.23.46.webp" alt="Logo" class="logo">
        <div>
          <h1>Alumni Portal</h1>
          <p class="tagline">Registered Users</p>
        </div>
      </div>
      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="welcome.html">Dashboard</a>
        <a href="#" onclick="logout()" class="btn ghost small">Logout</a>
      </nav>
    </div>
  </header>

  <main class="container" style="margin-top:18px;">
  <!-- Collapsible Registered Alumni -->
<section class="users-box fade-up" style="margin-bottom:18px;">
  <div style="display:flex;align-items:center;justify-content:space-between;">
    <button onclick="toggleSection('alumniSection')" class="btn small ghost">Registered Alumni</button>
  </div>

  <div id="alumniSection" style="display:none; margin-top:14px;">
    <p class="muted">Below are accounts from the database. Only visible to admin.</p>
    <div style="margin:10px 0;">
      <button onclick="exportUsersCSV()" class="btn small ghost">Export CSV</button>
    </div>
    <table id="usersTable" class="users-table" style="margin-top:12px;">
      <thead><tr><th style="width:64px">#</th><th>Name</th><th>Email</th><th>Admin</th></tr></thead>
      <tbody></tbody>
    </table>
    <p id="noUsers" class="muted">No users found.</p>
    <p id="usersError" class="muted" style="color:red;"></p>
  </div>
</section>

<!-- Collapsible User Login Activity -->
<section class="users-box fade-up">
  <div style="display:flex;align-items:center;justify-content:space-between;">
    <button onclick="toggleSection('activitySection')" class="btn small ghost">User Login Activity</button>
  </div>

  <div id="activitySection" style="display:none; margin-top:14px;">
    <p class="muted">Below are login activities. Only visible to admin.</p>
    <div style="margin:10px 0;">
      <button onclick="exportActivityCSV()" class="btn small ghost">Export CSV</button>
    </div>
    <table id="activityTable" class="users-table" style="margin-top:12px;">
      <thead><tr><th style="width:64px">#</th><th>Email</th><th>Login Time</th></tr></thead>
      <tbody></tbody>
    </table>
    <p id="noActivity" class="muted">No login activity found.</p>
    <p id="adminError" class="muted" style="color:red;"></p>
  </div>
</section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>© 2025 Alumni Portal • Admin</p>
    </div>
  </footer>

  <script>
    // Use global config.js (do NOT redeclare API_BASE here). Read the value from window.
    const API = window.API_BASE || 'https://alumniportal-jg5p.onrender.com';

    // Auth check: must be admin & have token
    const current = JSON.parse(localStorage.getItem('currentUser') || 'null');
    const token = localStorage.getItem('token');
    // accept either role or is_admin flag for compatibility
    const isAdmin = current && (current.role === 'admin' || current.is_admin === true || current.isAdmin === true);
    if (!current || !token || !isAdmin) {
      // Not admin -> redirect to admin login
      window.location.href = 'admin-login.html';
    }

    // Helpers
    function showError(id, msg) {
      const el = document.getElementById(id);
      if (el) el.textContent = msg || '';
    }

    function toIST(iso) {
      try {
        return new Date(iso).toLocaleString('en-IN', {
          timeZone: 'Asia/Kolkata',
          year: 'numeric', month: 'short', day: 'numeric',
          hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
      } catch {
        return iso;
      }
    }

    // Fetch and render users
    function loadUsers() {
      showError('usersError', '');
      fetch(`${API}/api/users`, {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          showError('usersError', data.error);
          document.getElementById('usersTable').style.display = 'none';
          return;
        }
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = '';
        if (!data || data.length === 0) {
          document.getElementById('noUsers').style.display = 'block';
          document.getElementById('usersTable').style.display = 'none';
          return;
        }
        document.getElementById('noUsers').style.display = 'none';
        document.getElementById('usersTable').style.display = 'table';
        data.forEach((u, i) => {
          const tr = document.createElement('tr');
          // backend returns role (e.g. 'admin' or 'user'), not is_admin
          tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.email)}</td><td>${u.role === 'admin' ? 'Yes' : 'No'}</td>`;
          tbody.appendChild(tr);
        });
      })
      .catch(() => {
        showError('usersError','Server error.');
      });
    }

    // Fetch and render activity
    function loadActivity(){
      showError('adminError', '');
      fetch(`${API}/api/activity`, {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          showError('adminError', data.error);
          document.getElementById('activityTable').style.display = 'none';
          return;
        }
        const tbody = document.querySelector('#activityTable tbody');
        tbody.innerHTML = '';
        if (!data || data.length === 0) {
          document.getElementById('noActivity').style.display = 'block';
          document.getElementById('activityTable').style.display = 'none';
          return;
        }
        document.getElementById('noActivity').style.display = 'none';
        document.getElementById('activityTable').style.display = 'table';
        data.forEach((a, i) => {
          const timeField = a.when_ts || a.when || a.time;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(a.email || ('user:' + (a.user_id || 'N/A')))}</td><td>${escapeHtml(toIST(timeField))}</td>`;
          tbody.appendChild(tr);
        });
      })
      .catch(()=> {
        showError('adminError','Server error.');
      });
    }

    // ---------------- CSV export helpers (minimal) ----------------
    function toCSV(rows, columns) {
      const headers = columns.map(c => `"${String(c.label).replace(/"/g,'""')}"`).join(',');
      const lines = rows.map(row => {
        return columns.map(c => {
          const v = row[c.key] == null ? '' : String(row[c.key]);
          return `"${v.replace(/"/g,'""')}"`;
        }).join(',');
      });
      return [headers].concat(lines).join('\r\n');
    }

    function downloadCSV(text, filename) {
      const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Export users.csv (uses role)
    function exportUsersCSV() {
      fetch(`${API}/api/users`, {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) { alert('Error: ' + data.error); return; }
        const cols = [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Name' },
          { key: 'email', label: 'Email' },
          { key: 'role', label: 'Role' }
        ];
        const rows = data.map(r => ({ ...r, role: r.role === 'admin' ? 'Admin' : 'User' }));
        const csv = toCSV(rows, cols);
        downloadCSV(csv, 'users.csv');
      })
      .catch(err => { console.error(err); alert('Export failed'); });
    }

    // Export activity.csv (uses when_ts)
    function exportActivityCSV() {
      fetch(`${API}/api/activity`, {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) { alert('Error: ' + data.error); return; }
        const cols = [
          { key: 'id', label: 'ID' },
          { key: 'user_id', label: 'User ID' },
          { key: 'email', label: 'Email' },
          { key: 'when_ts', label: 'Login Time (IST)' }
        ];
        const rows = data.map(r => ({ ...r, when_ts: new Date(r.when_ts).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) }));
        const csv = toCSV(rows, cols);
        downloadCSV(csv, 'activity.csv');
      })
      .catch(err => { console.error(err); alert('Export failed'); });
    }

    // Toggle visibility of collapsible sections (Registered Alumni / Activity)
function toggleSection(id) {
  const el = document.getElementById(id);
  if (!el) return;
  // if collapsed -> show and load data; if shown -> hide
  const isHidden = el.style.display === 'none' || getComputedStyle(el).display === 'none';
  el.style.display = isHidden ? 'block' : 'none';

  // If showing, ensure data is loaded
  if (isHidden) {
    if (id === 'alumniSection') {
      loadUsers();
    } else if (id === 'activitySection') {
      loadActivity();
    }
  }
}
 
    // Initialize
    document.addEventListener('DOMContentLoaded', ()=>{
      // don't auto-load until section expanded; keep lazy loading behavior
    });

    // Utility
    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"'`=\/]/g, function(s) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',"/":'&#x2F;','`':'&#96;','=':'&#61;'})[s];
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', ()=>{ /* intentionally left blank */ });

    // Logout helper for header link
    function logout(){
      localStorage.removeItem('currentUser');
      localStorage.removeItem('token');
      window.location.href = 'index.html';
    }
  </script>
</body>
</html
